name: 'Security Code Scanner - CodeQL'
description: 'Run custom CodeQL analysis'
inputs:
  repo:
    description: 'Repository that requested the scan'
    required: true
  language:
    description: 'Programming language to analyze'
    required: true
  paths_ignored:
    description: 'Comma delimited paths to ignore during scan'
    required: false
  rules_excluded:
    description: 'Comma delimited IDs of rules to exclude'
    required: false

runs:
  using: 'composite'
  steps:
    - name: Checkout Custom Query Repository
      id: checkout-custom-query
      uses: actions/checkout@v4
      with:
        repository: witmicko/CodeQL-Queries
        ref: main
        path: ${{ github.workspace }}/custom-queries

    - name: Generate Config
      id: generate-config
      run: |
        cd ${{ github.action_path }}
        yarn install --immutable
        node scripts/generate-config.js
      shell: bash
      env:
        REPO: ${{inputs.repo}}
        LANGUAGE: ${{ inputs.language }}
        PATHS_IGNORED: ${{ inputs.paths_ignored}}
        RULES_EXCLUDED: ${{ inputs.rules_excluded}}
        
    - name: Initialize CodeQL  
      uses: github/codeql-action/init@v3
      with:
        config-file: ${{ github.action_path }}/codeql-config-generated.yml
        languages: ${{ inputs.language }}
        source-root: ${{ inputs.repo }}

    - name: Run CodeQL Analysis
      id: codeql-analysis
      uses: github/codeql-action/analyze@v3
      with:
        upload: false
        checkout_path: ${{ github.workspace }}/${{ inputs.repo }}

    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: ${{ steps.codeql-analysis.outputs.sarif-output }}
        category: codeql-${{ inputs.language }}
