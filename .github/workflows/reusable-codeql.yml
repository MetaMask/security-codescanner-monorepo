name: 'Reusable CodeQL Analysis'

on:
  workflow_call:
    inputs:
      languages:
        description: 'JSON array of programming languages to scan (e.g., ["javascript", "python"])'
        required: true
        type: string
      repo:
        description: 'Repository that requested the scan'
        required: true
        type: string
      paths_ignored:
        description: 'Comma delimited paths to ignore during scan'
        required: false
        type: string
        default: ''
      rules_excluded:
        description: 'Comma delimited IDs of rules to exclude'
        required: false
        type: string
        default: ''
    outputs:
      sarif-id:
        description: 'SARIF file identifier'
        value: ${{ jobs.codeql-analysis.outputs.sarif-id }}

jobs:
  codeql-analysis:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJSON(inputs.languages) }}

    outputs:
      sarif-id: ${{ steps.upload.outputs.sarif-id }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo }}
          path: ${{ inputs.repo }}

      - name: Call Security Code Scanner CodeQL Action
        id: codeql-scan
        uses: ./packages/codeql-action@main
        with:
          repo: ${{ inputs.repo }}
          language: ${{ matrix.language }}
          paths_ignored: ${{ inputs.paths_ignored }}
          rules_excluded: ${{ inputs.rules_excluded }}

      - name: Upload SARIF with language suffix
        id: upload
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.codeql-scan.outputs.sarif-output }}
          category: codeql-${{ matrix.language }}
